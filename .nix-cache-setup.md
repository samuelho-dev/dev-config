# Nix Binary Cache Setup (Backblaze B2)

**Status**: ✅ Operational (Authenticated Access)
**Date**: 2025-12-04
**Phase**: Phase 0 Day 1 - DevPod Nix Migration

## Overview

Self-hosted Nix binary cache on Backblaze B2 for faster package builds and reduced build times across development environments.

## Configuration

### B2 Bucket Details
- **Bucket**: `ai-dev-env`
- **Path**: `/nix/cache/`
- **S3 Endpoint**: `https://s3.us-east-005.backblazeb2.com`
- **Region**: `us-east-005`
- **Access**: Private (authenticated) - Public access requires payment history
- **Full URL**: `https://s3.us-east-005.backblazeb2.com/ai-dev-env/nix/cache`

### Signing Keys
- **Public Key**: Stored in `.nix-cache-public-key` (safe to commit)
  ```
  ai-dev-env-cache:tnq6DY4gINIayQn66wpDz5HdUmPE5hQDRE0ujMLTxQI=
  ```
- **Private Key**: Stored in 1Password (Dev vault → backblaze item → nix-signing-key field)
  - **Never commit the private key to git**
  - Only authorized users should have access to push packages

### Local Nix Configuration
File: `~/.config/nix/nix.conf`

```conf
# S3-compatible binary cache (Backblaze B2 - ai-dev-env bucket with /nix/cache prefix)
substituters = https://cache.nixos.org https://s3.us-east-005.backblazeb2.com/ai-dev-env/nix/cache
trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= ai-dev-env-cache:tnq6DY4gINIayQn66wpDz5HdUmPE5hQDRE0ujMLTxQI=
```

## Usage

### Pushing Packages to Cache (Requires Private Key)

```bash
# 1. Get private key from 1Password
op read "op://Dev/backblaze/nix-signing-key" > /tmp/cache-priv-key.pem

# 2. Build package
nix build nixpkgs#<package>

# 3. Push to B2 with credentials and signing
op run --env-file=<(cat <<'EOF'
AWS_ACCESS_KEY_ID=op://Dev/backblaze/access-key-id
AWS_SECRET_ACCESS_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- nix copy --to "s3://ai-dev-env/nix/cache?endpoint=s3.us-east-005.backblazeb2.com&region=us-east-005" --sign-with=/tmp/cache-priv-key.pem ./result

# 4. Clean up private key
shred -u /tmp/cache-priv-key.pem
```

### Pulling Packages from Cache

**Note**: Currently requires B2 credentials because the bucket is private. Once payment history is established, the bucket can be made public for reads.

#### With 1Password CLI
```bash
op run --env-file=<(cat <<'EOF'
AWS_ACCESS_KEY_ID=op://Dev/backblaze/access-key-id
AWS_SECRET_ACCESS_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- nix build nixpkgs#<package>
```

#### Public Access (Future)
Once the B2 account has payment history, update bucket to `allPublic`:
```bash
b2 bucket update ai-dev-env allPublic
```

Then pulling will work without credentials:
```bash
nix build nixpkgs#<package>
# Automatically pulls from B2 if available
```

## Verification

### Test Push/Pull Workflow
```bash
# 1. Build and push a test package
nix build nixpkgs#hello
op run --env-file=<(cat <<'EOF'
AWS_ACCESS_KEY_ID=op://Dev/backblaze/access-key-id
AWS_SECRET_ACCESS_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- nix copy --to "s3://ai-dev-env/nix/cache?endpoint=s3.us-east-005.backblazeb2.com&region=us-east-005" ./result

# 2. Delete local copy
nix-store --delete /nix/store/<hash>-hello-*

# 3. Rebuild (should pull from B2 cache)
op run --env-file=<(cat <<'EOF'
AWS_ACCESS_KEY_ID=op://Dev/backblaze/access-key-id
AWS_SECRET_ACCESS_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- nix build nixpkgs#hello
```

### Check Cache Contents
```bash
op run --env-file=<(cat <<'EOF'
B2_APPLICATION_KEY_ID=op://Dev/backblaze/access-key-id
B2_APPLICATION_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- b2 ls b2://ai-dev-env/nix/cache/
```

## Security Notes

1. **Private Key Security**:
   - Stored in 1Password (Dev vault)
   - Never commit to git
   - Only share with authorized team members
   - Required for pushing packages (not pulling)

2. **B2 Credentials**:
   - Stored in 1Password (Dev vault → backblaze item)
   - `access-key-id` and `access-secret-key` fields
   - Required for authenticated access
   - Use `op run` to inject credentials securely

3. **Package Signatures**:
   - All packages signed with private key on push
   - Nix verifies signatures using public key on pull
   - Ensures package integrity and authenticity

## Troubleshooting

### 401 Unauthorized Error
**Cause**: Bucket is private and requires authentication
**Solution**: Use `op run` to inject B2 credentials (see usage examples above)

### "no_payment_history" Error When Making Bucket Public
**Cause**: B2 requires payment history before allowing public buckets
**Solution**: Add payment method to B2 account, then run:
```bash
b2 bucket update ai-dev-env allPublic
```

### Missing Package in Cache
**Cause**: Package hasn't been pushed yet
**Solution**: Build locally and push to cache (see "Pushing Packages" section)

## GitHub Actions Integration

The `.github/workflows/build-devpod-image.yaml` workflow is configured to automatically build and push to the B2 cache on every push to the `main` branch.

### Required GitHub Secrets

Add these secrets to your repository: **Settings → Secrets and variables → Actions → New repository secret**

| Secret Name | Source | Description |
|-------------|--------|-------------|
| `B2_ACCESS_KEY_ID` | 1Password: Dev/backblaze/access-key-id | B2 application key ID for S3 API access |
| `B2_SECRET_ACCESS_KEY` | 1Password: Dev/backblaze/access-secret-key | B2 application key secret |
| `NIX_SIGNING_KEY` | 1Password: Dev/backblaze/nix-signing-key | Nix cache private signing key |

### How to Add Secrets

Using 1Password CLI:

```bash
# Navigate to repository
cd /Users/samuelho/Projects/dev-config

# Get B2 access key ID
op read "op://Dev/backblaze/access-key-id"
# Copy output and add as B2_ACCESS_KEY_ID secret in GitHub

# Get B2 secret access key
op read "op://Dev/backblaze/access-secret-key"
# Copy output and add as B2_SECRET_ACCESS_KEY secret in GitHub

# Get Nix signing key
op read "op://Dev/backblaze/nix-signing-key"
# Copy output and add as NIX_SIGNING_KEY secret in GitHub
```

Or use the GitHub CLI:

```bash
# Set secrets directly from 1Password
gh secret set B2_ACCESS_KEY_ID --body "$(op read 'op://Dev/backblaze/access-key-id')"
gh secret set B2_SECRET_ACCESS_KEY --body "$(op read 'op://Dev/backblaze/access-secret-key')"
gh secret set NIX_SIGNING_KEY --body "$(op read 'op://Dev/backblaze/nix-signing-key')"
```

### Workflow Behavior

- **On Push to main**: Builds DevPod image, pushes to B2 cache with signing, pushes Docker image to GHCR
- **On Pull Request**: Builds only (no push to cache or registry)
- **Manual Trigger**: Can skip cache push for testing

### Testing the Workflow

```bash
# Create feature branch
git checkout -b test/github-actions-b2-cache

# Make a small change (e.g., update README)
echo "# Testing B2 cache workflow" >> TESTING.md
git add TESTING.md
git commit -m "test: trigger GitHub Actions workflow"

# Push to GitHub
git push origin test/github-actions-b2-cache

# Check workflow status
gh run list --workflow=build-devpod-image.yaml
```

## Next Steps

1. **Enable Public Access** (when payment history established):
   ```bash
   b2 bucket update ai-dev-env allPublic
   ```

2. **Team Onboarding** (Phase 0 Days 2-3):
   - Share public key with team (already in git)
   - Configure `nix.conf` on all development machines
   - Train team on push/pull workflows

3. **GitHub Actions Integration** (Phase 0 Day 4):
   - Add B2 credentials to GitHub Secrets
   - Configure CI/CD to push build artifacts to cache
   - Enable cache substitution in build workflows

4. **Monitoring** (Phase 0 Day 5):
   - Track cache hit rates
   - Monitor B2 storage usage
   - Measure build time improvements

## References

- [Nix Binary Cache Documentation](https://nixos.org/manual/nix/stable/package-management/binary-cache-substituter)
- [Backblaze B2 S3 Compatibility](https://www.backblaze.com/b2/docs/s3_compatible_api.html)
- [DevPod Nix Migration Plan](../.claude-work/plans/velvety-baking-cray.md)
