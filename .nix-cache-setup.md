# Nix Binary Cache Setup

**Status**: ✅ Operational
**Updated**: 2025-12-04

## B2 Configuration

| Parameter | Value |
|-----------|-------|
| Bucket | `ai-dev-env` |
| Path | `/nix/cache/` |
| Endpoint | `s3.us-east-005.backblazeb2.com` |
| Region | `us-east-005` |
| Access | Private (authenticated) |
| Public Key | `ai-dev-env-cache:tnq6DY4gINIayQn66wpDz5HdUmPE5hQDRE0ujMLTxQI=` |

**Credentials**: 1Password → Dev/backblaze

## Local Nix Configuration

File: `~/.config/nix/nix.conf`

```conf
substituters = https://cache.nixos.org https://s3.us-east-005.backblazeb2.com/ai-dev-env/nix/cache
trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= ai-dev-env-cache:tnq6DY4gINIayQn66wpDz5HdUmPE5hQDRE0ujMLTxQI=
```

## Usage

### Push to Cache

```bash
# Get signing key
op read "op://Dev/backblaze/nix-signing-key" > /tmp/cache-priv-key.pem

# Build and sign
nix build .#devpod-image
nix store sign --key-file /tmp/cache-priv-key.pem ./result

# Push with credentials
op run --env-file=<(cat <<'EOF'
AWS_ACCESS_KEY_ID=op://Dev/backblaze/access-key-id
AWS_SECRET_ACCESS_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- nix copy --to "s3://ai-dev-env/nix/cache?endpoint=s3.us-east-005.backblazeb2.com&region=us-east-005" ./result

# Cleanup
shred -u /tmp/cache-priv-key.pem
```

### Pull from Cache

Requires B2 credentials (bucket is private):

```bash
op run --env-file=<(cat <<'EOF'
AWS_ACCESS_KEY_ID=op://Dev/backblaze/access-key-id
AWS_SECRET_ACCESS_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- nix build .#devpod-image
```

## GitHub Actions

Workflow `.github/workflows/build-devpod-image.yaml` automatically builds and pushes to B2 on push to `main`.

### Required Secrets

| Secret | Source |
|--------|--------|
| `B2_ACCESS_KEY_ID` | `op://Dev/backblaze/access-key-id` |
| `B2_SECRET_ACCESS_KEY` | `op://Dev/backblaze/access-secret-key` |
| `NIX_SIGNING_KEY` | `op://Dev/backblaze/nix-signing-key` |

### Add Secrets

```bash
gh secret set B2_ACCESS_KEY_ID --body "$(op read 'op://Dev/backblaze/access-key-id')"
gh secret set B2_SECRET_ACCESS_KEY --body "$(op read 'op://Dev/backblaze/access-secret-key')"
gh secret set NIX_SIGNING_KEY --body "$(op read 'op://Dev/backblaze/nix-signing-key')"
```

### Workflow Triggers

- **Push to main**: Build + push to B2 + push to GHCR
- **Pull request**: Build only
- **Manual**: Optional skip cache push

## Verification

```bash
# Check cache contents
op run --env-file=<(cat <<'EOF'
B2_APPLICATION_KEY_ID=op://Dev/backblaze/access-key-id
B2_APPLICATION_KEY=op://Dev/backblaze/access-secret-key
EOF
) -- b2 ls b2://ai-dev-env/nix/cache/

# Test workflow
gh run list --workflow=build-devpod-image.yaml
```
