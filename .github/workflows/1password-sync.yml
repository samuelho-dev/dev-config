name: 1Password Sync

on:
  schedule:
    - cron: '*/5 * * * *'  # Check every 5 minutes
  workflow_dispatch:       # Allow manual triggering

concurrency:
  group: '1password-sync'
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Setup SOPS & Age
        run: |
          # Install SOPS
          SOPS_VERSION="v3.8.1"
          curl -L "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" -o sops
          chmod +x sops
          sudo mv sops /usr/local/bin/

          # Install Age
          AGE_VERSION="v1.1.1"
          curl -L "https://github.com/FiloSottile/age/releases/download/${AGE_VERSION}/age-${AGE_VERSION}-linux-amd64.tar.gz" -o age.tar.gz
          tar -xzf age.tar.gz
          sudo mv age/age /usr/local/bin/
          sudo mv age/age-keygen /usr/local/bin/
          rm -rf age age.tar.gz

      - name: Sync Secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          WORKFLOW_AGE_KEY: ${{ secrets.WORKFLOW_AGE_KEY }}
        run: |
          # 1. Configure Age Key
          mkdir -p ~/.config/sops/age
          echo "$WORKFLOW_AGE_KEY" > ~/.config/sops/age/keys.txt
          export SOPS_AGE_KEY_FILE=~/.config/sops/age/keys.txt

          # 2. Fetch Latest Secrets from 1Password (Cleartext)
          echo "Fetching secrets from 1Password..."
          GH_TOKEN=$(op read "op://Dev/Github/GITHUB_PAT")
          OP_TOKEN=$(op read "op://Dev/qse5t3rs5r22xossyqil2r2wue/credential")
          printf 'git:\n    github_token: %s\nop:\n    service_account_token: %s\n' "$GH_TOKEN" "$OP_TOKEN" > secrets_new.yaml

          # 3. Decrypt Existing Secrets (Cleartext)
          # We use a dummy file if the secret file doesn't exist yet
          if [ -f secrets/default.yaml ]; then
            sops --decrypt secrets/default.yaml > secrets_current.yaml 2>/dev/null || echo "" > secrets_current.yaml
          else
            echo "" > secrets_current.yaml
          fi

          # 4. Compare Content
          # We use diff to check if there are actual value changes
          if cmp -s secrets_new.yaml secrets_current.yaml; then
            echo "✅ No changes detected in secrets. Skipping update."
            echo "has_changes=false" >> "$GITHUB_ENV"
          else
            echo "⚠️ Changes detected! Updating secrets..."
            echo "has_changes=true" >> "$GITHUB_ENV"

            # Encrypt the NEW content over the destination
            # We derive the public key to explicitly encrypt for it
            # We disable config lookup (--config /dev/null) to avoid "no matching creation rules" error for the temp input file
            WORKFLOW_PUBLIC_KEY=$(age-keygen -y ~/.config/sops/age/keys.txt)
            sops --config /dev/null --encrypt --age "$WORKFLOW_PUBLIC_KEY" secrets_new.yaml > secrets/default.tmp
            mv secrets/default.tmp secrets/default.yaml
          fi

          # Cleanup cleartext files immediately
          rm -f secrets_new.yaml secrets_current.yaml

      - name: Commit Changes
        if: env.has_changes == 'true'
        run: |
          git config user.name "1Password Sync Bot"
          git config user.email "bot@noreply.github.com"

          git add secrets/default.yaml
          git commit -m "chore: sync secrets from 1Password [skip ci]"
          git push
