# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with Yazi terminal file manager configuration in this directory.

## Directory Purpose

This directory is a **placeholder for future Yazi configuration files**. Currently, Yazi is configured **declaratively through Home Manager** in `modules/home-manager/programs/yazi.nix`, with no custom configuration files needed.

## Current Architecture

### Declarative Configuration (No Config Files)

**Location:** `modules/home-manager/programs/yazi.nix`

Yazi is configured using Home Manager's built-in `programs.yazi` module with declarative Nix options:

```nix
programs.yazi = {
  enable = true;
  enableZshIntegration = true;
  shellWrapperName = "yy";

  settings = {
    manager = {
      ratio = [ 1 4 3 ];
      sort_by = "natural";
      sort_dir_first = true;
    };
    preview = {
      max_width = 1000;
      max_height = 1000;
    };
  };

  keymap = {
    manager.prepend_keymap = [
      { on = [ "<C-s>" ]; run = "search fd"; desc = "Search files with fd"; }
      { on = [ "<C-g>" ]; run = "search rg"; desc = "Search content with ripgrep"; }
    ];
  };
};
```

**Configuration outputs:**
- `~/.config/yazi/yazi.toml` (generated from `settings`)
- `~/.config/yazi/keymap.toml` (generated from `keymap`)
- `~/.config/yazi/theme.toml` (generated from `theme`)

## Why No Config Files?

**Design Decision: Declarative-First Approach**

1. **Yazi works perfectly with defaults** - No custom configs needed for basic usage
2. **Home Manager generates configs** - From Nix options to TOML files
3. **Type-safe configuration** - Nix validates options at build time
4. **Reproducible** - Same configuration across all machines
5. **Version controlled** - All settings in `yazi.nix`

## When to Add Config Files

If you need **extensive customization** beyond what Home Manager's declarative options provide:

### File Structure

```
yazi/
├── CLAUDE.md              # This file
├── yazi.toml              # General settings overrides
├── keymap.toml            # Custom keybindings
├── theme.toml             # Color scheme customization
├── init.lua               # Lua initialization script
├── plugins/               # Custom plugins
│   └── *.yazi/
│       └── main.lua
└── flavors/               # Theme collections
    └── *.yazi/
```

### Configuration Files Overview

**yazi.toml** - General behavior
```toml
[manager]
ratio = [1, 4, 3]
sort_by = "natural"
sort_dir_first = true
show_hidden = false

[preview]
max_width = 1000
max_height = 1000
```

**keymap.toml** - Keyboard shortcuts
```toml
[[manager.prepend_keymap]]
on = ["<C-s>"]
run = "search fd"
desc = "Search with fd"

[[manager.prepend_keymap]]
on = ["<C-g>"]
run = "search rg"
desc = "Search with ripgrep"
```

**theme.toml** - Visual styling
```toml
[manager]
cwd = { fg = "cyan" }

[filetype]
rules = [
  { mime = "image/*", fg = "yellow" },
  { mime = "video/*", fg = "magenta" },
]
```

**init.lua** - Lua initialization
```lua
-- Plugin setup
require("plugins.my-plugin"):setup()

-- Custom functions
function MyFunction()
  -- Implementation
end
```

## Shell Integration

### The `yy` Wrapper Function

Yazi needs a shell wrapper to change the working directory when you exit.

**Auto-generated by Home Manager when `enableZshIntegration = true`:**

```bash
function yy() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
  yazi "$@" --cwd-file="$tmp"
  if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd -- "$cwd"
  fi
  rm -f -- "$tmp"
}
```

**Usage:**
- `yy` - Start yazi, press `q` to quit and **change to the navigated directory**
- `yazi` - Start yazi without cd-on-exit wrapper
- `Q` (inside yazi) - Quit **without changing directory**

### Why `yy` instead of `yazi`?

Yazi introduced a CLI tool named `ya` in recent versions, so the wrapper was renamed from `ya` to `yy` to avoid conflicts.

## Keybindings

### Shell

- `yy` - Open yazi with cd-on-exit wrapper
- `yazi` - Open yazi without wrapper

### Inside Yazi (Default + Custom)

**Navigation:**
- `j/k` - Move down/up
- `h/l` - Go to parent/enter directory
- `g` - Go to top
- `G` - Go to bottom
- `<C-u>/<C-d>` - Page up/down

**Selection:**
- `<Space>` - Toggle selection
- `v` - Visual mode (select multiple)
- `V` - Visual mode (unselect)

**Operations:**
- `y` - Yank (copy)
- `x` - Cut
- `p` - Paste
- `d` - Delete
- `r` - Rename
- `c` - Create file/directory
- `o` - Open with default app

**Search (Custom via Home Manager):**
- `<C-s>` - Search files with fd
- `<C-g>` - Search content with ripgrep
- `<C-z>` - Jump to directory with zoxide (if configured)

**Tabs:**
- `t` - New tab
- `<Tab>` - Next tab
- `<S-Tab>` - Previous tab
- `<C-w>` - Close tab

**Other:**
- `~` - Go to home directory
- `/` - Search in current directory
- `:` - Command mode
- `?` - Help

### Neovim (yazi.nvim plugin)

**Location:** `nvim/lua/plugins/editor.lua`

- `<leader>fy` - Open yazi file manager
- `<leader>fw` - Open yazi in working directory
- `<leader>fY` - Resume last yazi session

**Inside yazi (from Neovim):**
- `<c-s>` - Telescope live_grep in yazi directory
- `<c-v>` - Open file in vertical split
- `<c-x>` - Open file in horizontal split
- `<c-t>` - Open file in new tab
- `<tab>` - Cycle through open buffers
- `<c-y>` - Copy relative path to selected files

## Preview Dependencies

**Location:** Configured in `modules/home-manager/programs/yazi.nix`

Yazi includes these tools for rich file previews:

**Video/Images:**
- `ffmpegthumbnailer` - Video thumbnails
- `imagemagick` - Image processing

**Documents:**
- `poppler` - PDF previews

**Archives:**
- `p7zip` - Archive extraction and viewing

**Data:**
- `jq` - JSON file formatting
- `yq-go` - YAML file formatting

**Search (Already in dev-config):**
- `fd` - Fast file search
- `ripgrep` - Content search
- `fzf` - Fuzzy finding

## Tmux Integration

**Image preview support enabled in `modules/home-manager/programs/tmux.nix`:**

```tmux
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM
```

This allows yazi to display image previews inline in tmux using the Kitty graphics protocol (works in Ghostty terminal).

## Neovim Integration

**Plugin:** `mikavilpas/yazi.nvim`

**Features:**
- Open yazi as a floating window in Neovim
- File highlighting - files hovered in yazi are highlighted in Neovim
- Telescope integration - `<c-s>` to search current directory with live_grep
- Multi-file selection support
- Resume last session with toggle command

**Configuration:** See `nvim/lua/plugins/editor.lua:53-101`

## Common Use Cases

### Quick File Navigation

```bash
# Open yazi in current directory
yy

# Navigate with j/k, press Enter to open file
# Press q to quit and stay in navigated directory
```

### Search and Open

```bash
# Inside yazi:
# 1. Press <C-s> to search files with fd
# 2. Type pattern, press Enter
# 3. Navigate results, press Enter to open
```

### Copy/Move Files

```bash
# Inside yazi:
# 1. Select files with <Space> or v (visual mode)
# 2. Press y to yank (copy) or x to cut
# 3. Navigate to destination
# 4. Press p to paste
```

### Bulk Rename

```bash
# Inside yazi:
# 1. Select files with visual mode (v)
# 2. Press r to rename
# 3. Edit filenames in editor
# 4. Save and quit
```

### Image Preview

```bash
# Works in Ghostty terminal + tmux
# Navigate to image files, yazi shows inline preview
```

## Configuration Customization

### Extending Home Manager Config

**File:** `modules/home-manager/programs/yazi.nix`

**Add custom keybindings:**
```nix
keymap = {
  manager.prepend_keymap = [
    { on = [ "<C-s>" ]; run = "search fd"; desc = "Search with fd"; }
    { on = [ "<C-g>" ]; run = "search rg"; desc = "Search with ripgrep"; }

    # Add your custom keybinding
    { on = [ "<C-f>" ]; run = "plugin my-plugin"; desc = "Run my plugin"; }
  ];
};
```

**Add custom settings:**
```nix
settings = {
  manager = {
    ratio = [ 1 4 3 ];
    # Add custom setting
    show_symlink = true;
  };
  preview = {
    max_width = 1000;
    # Add custom setting
    tab_size = 2;
  };
};
```

**Add custom theme:**
```nix
theme = {
  manager = {
    cwd = { fg = "cyan"; };
  };
  filetype = {
    rules = [
      { mime = "image/*"; fg = "yellow"; }
      { mime = "video/*"; fg = "magenta"; }
    ];
  };
};
```

### Switching to File-Based Config

If you prefer TOML/Lua config files over declarative Nix:

1. **Create config files** in this directory (`yazi.toml`, `keymap.toml`, etc.)

2. **Update Home Manager module** (`modules/home-manager/programs/yazi.nix`):
   ```nix
   # Remove declarative settings
   # settings = { ... };
   # keymap = { ... };
   # theme = { ... };

   # Keep only enable and shell integration
   programs.yazi = {
     enable = true;
     enableZshIntegration = true;
   };

   # Add symlink to config directory
   xdg.configFile."yazi" = {
     source = if inputs ? dev-config then "${inputs.dev-config}/yazi" else null;
   };
   ```

3. **Apply changes:**
   ```bash
   home-manager switch --flake ~/Projects/dev-config
   ```

## Troubleshooting

### Yazi not changing directory on exit

**Issue:** Running `yazi` directly instead of `yy` wrapper

**Fix:** Use `yy` command (generated by Home Manager):
```bash
yy  # Correct - uses wrapper
```

### Image previews not working

**Issue 1:** Tmux passthrough not configured

**Fix:** Check `modules/home-manager/programs/tmux.nix` has extraConfig:
```nix
extraConfig = ''
  set -g allow-passthrough on
  set -ga update-environment TERM
  set -ga update-environment TERM_PROGRAM
'';
```

**Issue 2:** Terminal doesn't support Kitty protocol

**Fix:** Use Ghostty terminal (supports Kitty graphics protocol)

### PDF/Video previews not working

**Issue:** Preview tools not installed

**Fix:** Check `extraPackages` in `modules/home-manager/programs/yazi.nix`:
```nix
extraPackages = with pkgs; [
  ffmpegthumbnailer  # Video
  poppler            # PDF
  imagemagick        # Images
  p7zip              # Archives
];
```

### Keybinding not working

**Issue:** Keybinding conflict or not configured

**Fix:** Check `keymap` in `modules/home-manager/programs/yazi.nix`

### Yazi not loading

**Issue:** Module not enabled in `home.nix`

**Fix:** Ensure enabled in home configuration:
```nix
dev-config = {
  enable = true;
  yazi.enable = true;
};
```

## Integration with Existing Tools

### Already Integrated (via dev-config)

Yazi automatically works with these tools from `modules/home-manager/default.nix`:

- `ripgrep` (rg) - Content search (`<C-g>` inside yazi)
- `fd` - File search (`<C-s>` inside yazi)
- `fzf` - Fuzzy finding
- `bat` - Syntax highlighting in previews
- `imagemagick` - Image processing

### Optional Integration

**zoxide** - Smart directory jumping
```nix
# In modules/home-manager/programs/yazi.nix
keymap = {
  manager.prepend_keymap = [
    { on = [ "<C-z>" ]; run = "plugin zoxide"; desc = "Jump with zoxide"; }
  ];
};
```

**Requires:** Install zoxide plugin for yazi

## Performance

### Startup Time

Yazi uses **async I/O** - very fast startup even in large directories.

### Memory Usage

Minimal memory footprint - only loads visible files incrementally.

### Large Directories

Yazi handles large directories efficiently:
- Incremental loading (loads in chunks)
- Pre-loading mechanism for navigation
- Fast directory traversal

## For Future Claude Code Instances

**When modifying yazi configuration:**

1. **Check current approach:**
   - Declarative (Nix) - Edit `modules/home-manager/programs/yazi.nix`
   - File-based (TOML/Lua) - Edit files in `yazi/` directory

2. **Adding keybindings:**
   - Declarative: Add to `keymap.manager.prepend_keymap` array
   - File-based: Edit `yazi/keymap.toml`

3. **Changing settings:**
   - Declarative: Modify `settings` table in yazi.nix
   - File-based: Edit `yazi/yazi.toml`

4. **Adding plugins:**
   - Create plugin in `yazi/plugins/my-plugin.yazi/main.lua`
   - Configure in `settings.plugin.prepend_preloaders` or `keymap`

5. **Testing changes:**
   ```bash
   # Rebuild Home Manager
   home-manager switch --flake ~/Projects/dev-config

   # Test yazi
   yy
   ```

6. **Common file locations:**
   - Home Manager module: `modules/home-manager/programs/yazi.nix`
   - Neovim integration: `nvim/lua/plugins/editor.lua`
   - Tmux config: `modules/home-manager/programs/tmux.nix`
   - Main documentation: `CLAUDE.md` (update integration section)

7. **Documentation updates:**
   - Update this file (yazi/CLAUDE.md) for yazi-specific changes
   - Update main CLAUDE.md for integration with other tools
   - Update README.md for user-facing features
