---
# Pre-commit hooks for dev-config
# Automatically installed via Nix devShell
#
# Manual installation:
#   pre-commit install
#
# Run manually:
#   pre-commit run --all-files

repos:
  - repo: local
    hooks:
      # Nix formatting
      - id: nix-fmt
        name: Format Nix files
        entry: nix fmt
        language: system
        files: \.nix$
        pass_filenames: true
        description: Check Nix file formatting with alejandra

      # Nix flake validation
      - id: nix-flake-check
        name: Validate Nix flake
        entry: nix flake check --no-build
        language: system
        files: \.nix$
        pass_filenames: false
        description: Validate flake.nix syntax and structure

      # Nix Home Manager syntax check
      - id: nix-syntax-check
        name: Home Manager Syntax Check
        entry: nix flake show --json
        language: system
        files: \.nix$
        pass_filenames: false
        description: Validate Home Manager configuration syntax

      # Secret scanning (enhanced)
      - id: gitleaks
        name: Detect hardcoded secrets
        entry: gitleaks protect --staged --verbose
        language: system
        pass_filenames: false
        description: Scan staged files for secrets and API keys

      # Biome formatting and linting (JS/TS/JSON)
      # NOTE: Biome is configured to ignore some JSON/TS files in this repo.
      # Pre-commit passes filenames explicitly; if Biome ignores them it fails with:
      # "No files were processed in the specified paths."
      #
      # We exclude known ignored paths to prevent false failures.
      - id: biome-check
        name: Biome format and lint
        entry: biome check --write
        language: system
        files: \.(js|jsx|ts|tsx|json|jsonc)$
        exclude: ^(\.opencode/|gritql-patterns/|nvim/lazy-lock\.json$|\.claude/settings\.json$|state/last_sync\.json$|tsconfig/tsconfig\.strict\.json$|tsconfig/tsconfig\.monorepo\.json$)
        pass_filenames: true
        description: Format and lint JavaScript/TypeScript/JSON with Biome

      # AI Guardrails: Linting config validation
      # Prevents AI (and developers) from weakening linting rules
      - id: validate-linting-config
        name: Validate linting config changes
        entry: bash scripts/validate-linting-config.sh
        language: system
        files: ^(biome.*\.json|tsconfig.*\.json|\.pre-commit-config\.yaml)$
        pass_filenames: false
        description: Prevent rule weakening and enforce linting policy

      # Kubernetes manifest linting
      - id: kube-linter
        name: Lint Kubernetes manifests
        entry: kube-linter lint --config iac-linting/.kube-linter.yaml
        language: system
        files: ^(k8s|deploy|charts)/.*\.ya?ml$
        pass_filenames: true
        description: Validate Kubernetes manifests with kube-linter

      # Dockerfile linting
      - id: hadolint
        name: Lint Dockerfiles
        entry: hadolint --config iac-linting/.hadolint.yaml
        language: system
        files: (Dockerfile|\.dockerfile)$
        pass_filenames: true
        description: Lint Dockerfiles with Hadolint

      # Terraform linting
      - id: tflint
        name: Lint Terraform files
        entry: tflint --config iac-linting/.tflint.hcl
        language: system
        files: \.tf$
        pass_filenames: false
        description: Lint Terraform configuration with TFLint

      # GitHub Actions linting
      - id: actionlint
        name: Lint GitHub Actions
        entry: actionlint
        language: system
        files: ^\.github/workflows/.*\.ya?ml$
        pass_filenames: true
        description: Lint GitHub Actions workflows with actionlint

      # GritQL pattern testing (disabled - requires grit CLI setup)
      # - id: grit-patterns-test
      #   name: Test GritQL patterns
      #   entry: grit patterns test
      #   language: system
      #   files: ^gritql-patterns/.*\.(md|grit)$
      #   pass_filenames: false
      #   description: Validate GritQL pattern syntax and test cases

  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
      - id: end-of-file-fixer
        name: Fix end of files
      - id: check-yaml
        name: Check YAML syntax
        args: ["--unsafe"] # Allow custom YAML tags
      - id: check-added-large-files
        name: Check for large files
        args: ["--maxkb=1000"]
      - id: check-merge-conflict
        name: Check for merge conflict markers
      - id: detect-private-key
        name: Detect private keys

  # Markdown linting
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.39.0
    hooks:
      - id: markdownlint
        name: Lint Markdown files
        args: ["--fix", "--disable", "MD013"] # Disable line length rule

  # Shell script linting
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        name: Lint shell scripts
        # Follow sourced files, exclude SC1091
        args: ["-x", "-e", "SC1091"]
        exclude: ^zsh/ # Exclude zsh config files (not bash scripts)
